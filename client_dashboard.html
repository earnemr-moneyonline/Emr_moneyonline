<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMR MARKET | Reality Feed</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --emr-gold: #ffc947; --bg-dark: #000; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: white; overflow: hidden; }

        .top-nav { position: fixed; top: 0; width: 100%; height: 80px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 15px; z-index: 1000; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        .nav-tabs { display: flex; gap: 25px; }
        .nav-tab { opacity: 0.6; cursor: pointer; font-weight: 700; font-size: 1.1rem; transition: 0.3s; }
        .nav-tab.active { opacity: 1; border-bottom: 3px solid white; }

        .feed { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .feed::-webkit-scrollbar { display: none; }
        .job-card { height: 100vh; width: 100%; scroll-snap-align: center; position: relative; display: flex; flex-direction: column; justify-content: flex-end; }
        
        .full-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: -1; }
        .overlay { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to top, rgba(0,0,0,1) 30%, transparent); }

        .platform-logo { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; object-fit: contain; opacity: 0.8; z-index: 2; pointer-events: none; }

        .side-bar { position: absolute; right: 12px; bottom: 120px; display: flex; flex-direction: column; gap: 22px; align-items: center; z-index: 10; }
        .pfp-wrap { width: 52px; height: 52px; border-radius: 50%; border: 2px solid white; background-size: cover; background-position: center; position: relative; }
        .follow-badge { position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); background: #fe2c55; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: 2px solid black; }
        
        .icon-group { text-align: center; cursor: pointer; }
        .icon-group i { font-size: 2.2rem; display: block; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .icon-group span { font-size: 0.75rem; font-weight: 600; margin-top: 2px; display: block; }

        .content-info { padding: 20px; margin-bottom: 85px; width: 85%; z-index: 5; }
        .user-handle { font-weight: 700; font-size: 1.2rem; margin-bottom: 8px; color: white; display: flex; align-items: center; gap: 5px; }
        .job-progress { font-size: 0.8rem; color: #ffc947; margin-bottom: 5px; font-weight: 600; }
        .job-desc { font-size: 0.95rem; line-height: 1.4; margin-bottom: 12px; color: #f5f5f5; }
        .job-desc a { color: var(--emr-gold); text-decoration: underline; font-weight: bold; }
        
        .price-tag { background: rgba(255, 201, 71, 0.2); color: var(--emr-gold); border: 1px solid var(--emr-gold); display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 800; margin-bottom: 10px; font-size: 0.9rem; }
        .btn-work { width: 100%; background: var(--emr-gold); color: black; border: none; padding: 16px; border-radius: 12px; font-weight: 900; cursor: pointer; font-size: 1rem; text-transform: uppercase; }

        .bottom-menu { position: fixed; bottom: 0; width: 100%; height: 75px; background: black; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #222; z-index: 1000; }
        .menu-item { color: #888; text-decoration: none; font-size: 1.7rem; }
        .menu-item.active { color: white; }
    </style>
</head>
<body>

    <div class="top-nav">
        <div class="nav-tabs">
            <div id="forYouTab" class="nav-tab active" onclick="fetchJobs('foryou')">For You</div>
            <div id="followingTab" class="nav-tab" onclick="fetchJobs('following')">Following</div>
        </div>
    </div>

    <div class="feed" id="feedContainer"></div>

    <div class="bottom-menu">
        <a href="index.html" class="menu-item active"><i class="fas fa-home"></i></a>
        <a href="discover.html" class="menu-item"><i class="fas fa-search"></i></a>
        <a href="notifications.html" class="menu-item"><i class="fas fa-plus-circle" style="color:var(--emr-gold); font-size: 2.5rem;"></i></a>
        <a href="live_chat.html" class="menu-item"><i class="fas fa-comment-dots"></i></a>
        <a href="profile.html" class="menu-item"><i class="fas fa-user"></i></a>
    </div>

    <script>
        const _URL = 'https://bnskxnaqjmsrtzglsdug.supabase.co';
        const _KEY = 'sb_publishable_VZ5Up105f3DIr8bcrDFqmA_jwL4vA3K';
        const _supabase = supabase.createClient(_URL, _KEY);

        function getPlatformLogo(text) {
            const lower = (text || "").toLowerCase();
            if (lower.includes('instagram')) return 'https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png';
            if (lower.includes('facebook')) return 'https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_(2019).png';
            if (lower.includes('tiktok')) return 'https://cdn-icons-png.flaticon.com/512/3046/3046121.png';
            return ''; 
        }

        async function fetchJobs(mode = 'foryou') {
            const feed = document.getElementById('feedContainer');
            feed.innerHTML = '<center style="padding-top:50vh">Inapakia...</center>';
            
            // Tab Toggle UI
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(mode === 'foryou' ? 'forYouTab' : 'followingTab').classList.add('active');

            const { data: { user } } = await _supabase.auth.getUser();

            // Query ya msingi
            let query = _supabase
                .from('jobs')
                .select(`
                    *, 
                    profiles:merchant_id (
                        full_name, avatar_url, username,
                        followers!merchant_id (follower_id)
                    ),
                    job_likes (user_id),
                    submissions:job_submissions(count)
                `);

            const { data: jobs, error } = await query;
            if (error) { feed.innerHTML = `<center style="margin-top:50%">${error.message}</center>`; return; }

            // Logic ya Filtering kwa Tab ya Following
            let filteredJobs = jobs;
            if (mode === 'following' && user) {
                filteredJobs = jobs.filter(job => 
                    job.profiles?.followers?.some(f => f.follower_id === user.id)
                );
            }

            if (filteredJobs.length === 0) {
                feed.innerHTML = `<center style="padding-top:50vh">Bado haujamfuata mtu yeyote.</center>`;
                return;
            }

            feed.innerHTML = '';
            filteredJobs.forEach(job => {
                const profile = job.profiles;
                const firstName = (profile?.full_name || "Merchant").split(' ')[0];
                const avatar = profile?.avatar_url || 'https://i.pravatar.cc/100';
                
                // Progress Logic
                const done = job.submissions?.[0]?.count || 0;
                const total = job.required_workers || 100; // Unapaswa kuwa na column hii kwenye table ya jobs
                const remaining = total - done;

                const platformLogo = getPlatformLogo(job.description + job.title);
                const hasLiked = user && job.job_likes?.some(l => l.user_id === user.id);
                const isFollowing = user && profile?.followers?.some(f => f.follower_id === user.id);

                feed.innerHTML += `
                <div class="job-card">
                    <div class="full-img" style="background-image: url('${job.image_url}')"></div>
                    ${platformLogo ? `<img src="${platformLogo}" class="platform-logo">` : ''}
                    <div class="overlay"></div>
                    
                    <div class="side-bar">
                        <div class="pfp-wrap" style="background-image: url('${avatar}')">
                            <div class="follow-badge" style="display: ${isFollowing ? 'none' : 'flex'}" onclick="followMerchant('${job.merchant_id}', this)">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                        <div class="icon-group" onclick="likeJob(${job.id}, this)">
                            <i class="fas fa-heart" style="color: ${hasLiked ? 'red' : 'white'}"></i>
                            <span class="label">Like</span>
                        </div>
                        <div class="icon-group" onclick="shareIt()"><i class="fas fa-share"></i><span>Share</span></div>
                    </div>

                    <div class="content-info">
                        <div class="user-handle" onclick="location.href='profile.html?id=${job.merchant_id}'">
                            @${firstName} <i class="fas fa-check-circle" style="color:#1da1f2; font-size:14px"></i>
                        </div>
                        <div class="job-progress">${done} wameshafanya â€¢ Nafasi ${remaining} zimebaki</div>
                        <div class="job-desc">${job.title}</div>
                        <div class="price-tag">Unakusanya: TZS ${job.price}</div>
                        <button class="btn-work" onclick="startTask('${job.id}')">ANZA KAZI</button>
                    </div>
                </div>`;
            });
        }

        async function likeJob(jobId, el) {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return alert("Ingia kwanza!");
            const icon = el.querySelector('i');
            if (icon.style.color === 'red') {
                await _supabase.from('job_likes').delete().match({ user_id: user.id, job_id: jobId });
                icon.style.color = 'white';
            } else {
                await _supabase.from('job_likes').insert([{ user_id: user.id, job_id: jobId }]);
                icon.style.color = 'red';
            }
        }

        async function followMerchant(mId, el) {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return alert("Ingia kwanza!");
            const { error } = await _supabase.from('followers').insert([{ follower_id: user.id, merchant_id: mId }]);
            if (!error) { el.style.display = 'none'; alert("Umeanza kumfuata!"); }
        }

        function shareIt() { if (navigator.share) navigator.share({title: 'EMR Job', url: window.location.href}); }
        function startTask(id) { alert("Kazi imeanza! Screenshot matokeo."); }

        fetchJobs('foryou');
    </script>
</body>
</html>
