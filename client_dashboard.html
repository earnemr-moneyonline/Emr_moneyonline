<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMR MARKET | Reality Feed</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --emr-gold: #ffc947; --bg-dark: #000; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: white; overflow: hidden; }

        .top-nav { position: fixed; top: 0; width: 100%; height: 80px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; z-index: 1000; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); }
        .nav-tabs { display: flex; gap: 20px; font-weight: 700; }
        .nav-tab { opacity: 0.6; cursor: pointer; position: relative; font-size: 1.1rem; }
        .nav-tab.active { opacity: 1; border-bottom: 3px solid white; }

        .feed { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .feed::-webkit-scrollbar { display: none; }
        
        .job-card { height: 100vh; width: 100%; scroll-snap-align: center; position: relative; display: flex; flex-direction: column; justify-content: flex-end; }
        .full-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: -1; }
        .overlay { position: absolute; bottom: 0; width: 100%; height: 60%; background: linear-gradient(to top, rgba(0,0,0,1) 10%, rgba(0,0,0,0.5) 50%, transparent); }

        .side-bar { position: absolute; right: 12px; bottom: 130px; display: flex; flex-direction: column; gap: 20px; align-items: center; z-index: 10; }
        .icon-group { text-align: center; cursor: pointer; transition: transform 0.2s; }
        .icon-group:active { transform: scale(0.9); }
        .icon-group i { font-size: 2.2rem; display: block; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .icon-group span { font-size: 0.75rem; font-weight: 600; margin-top: 2px; display: block; }
        
        .pfp-wrap { width: 52px; height: 52px; border-radius: 50%; border: 2px solid white; background-size: cover; background-position: center; position: relative; margin-bottom: 5px; }
        .follow-badge { position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: #fe2c55; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid black; cursor: pointer; }

        .content-info { padding: 20px; margin-bottom: 85px; width: 85%; z-index: 5; }
        .user-handle { font-weight: 700; font-size: 1.2rem; margin-bottom: 5px; color: white; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .job-desc { font-size: 0.95rem; line-height: 1.4; opacity: 0.9; margin-bottom: 12px; color: #eee; }
        .job-desc a { color: var(--emr-gold); text-decoration: underline; pointer-events: auto; }

        .price-badge { background: var(--emr-gold); color: black; display: inline-block; padding: 6px 15px; border-radius: 8px; font-weight: 800; margin-bottom: 15px; }

        .bottom-menu { position: fixed; bottom: 0; width: 100%; height: 75px; background: #000; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #222; z-index: 1001; }
        .menu-item { color: #777; text-align: center; cursor: pointer; text-decoration: none; }
        .menu-item.active { color: white; }
        .menu-item i { font-size: 1.6rem; }
        .notif-btn { color: var(--emr-gold) !important; font-size: 2.3rem !important; }
    </style>
</head>
<body>

    <div class="top-nav">
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="fetchJobs()">For You</div>
            <div class="nav-tab" onclick="fetchJobs()">Following</div>
        </div>
    </div>

    <div class="feed" id="feedContainer"></div>

    <div class="bottom-menu">
        <a href="index.html" class="menu-item active"><i class="fas fa-home"></i></a>
        <a href="discover.html" class="menu-item"><i class="fas fa-search"></i></a>
        <a href="notifications.html" class="menu-item"><i class="fas fa-plus-circle notif-btn"></i></a>
        <a href="live_chat.html" class="menu-item"><i class="fas fa-comment-dots"></i></a>
        <a href="profile.html" class="menu-item"><i class="fas fa-user"></i></a>
    </div>

    <script>
        const _URL = 'https://bnskxnaqjmsrtzglsdug.supabase.co';
        const _KEY = 'sb_publishable_VZ5Up105f3DIr8bcrDFqmA_jwL4vA3K';
        const _supabase = supabase.createClient(_URL, _KEY);

        async function fetchJobs() {
            const feed = document.getElementById('feedContainer');
            const { data: jobs, error } = await _supabase
                .from('jobs')
                .select('*, profiles!merchant_id(full_name, avatar_url, username)');

            if (error) {
                feed.innerHTML = `<div style="padding:100px; text-align:center">${error.message}</div>`;
                return;
            }

            feed.innerHTML = '';
            jobs.forEach(job => {
                const fullName = job.profiles?.full_name || job.profiles?.username || 'Merchant';
                const firstName = fullName.split(' ')[0];
                const avatar = job.profiles?.avatar_url || 'https://i.pravatar.cc/100';
                const descWithLinks = job.description.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');

                feed.innerHTML += `
                <div class="job-card">
                    <div class="full-img" style="background-image: url('${job.image_url}')"></div>
                    <div class="overlay"></div>
                    <div class="side-bar">
                        <div class="pfp-wrap" style="background-image: url('${avatar}')">
                            <div class="follow-badge" onclick="followMerchant('${job.merchant_id}', this)"><i class="fas fa-plus"></i></div>
                        </div>
                        <div class="icon-group" onclick="likeJob(${job.id}, this)">
                            <i class="fas fa-heart"></i>
                            <span class="like-count">Like</span>
                        </div>
                        <div class="icon-group" onclick="shareIt()">
                            <i class="fas fa-share"></i>
                            <span>Share</span>
                        </div>
                        <div class="icon-group">
                            <i class="fas fa-bookmark"></i>
                            <span>Save</span>
                        </div>
                    </div>
                    <div class="content-info">
                        <div class="user-handle" onclick="location.href='profile.html?id=${job.merchant_id}'">
                            @${firstName} <i class="fas fa-check-circle" style="color:#1da1f2; font-size:14px"></i>
                        </div>
                        <div class="job-desc"><strong>${job.title}</strong><br>${descWithLinks}</div>
                        <div class="price-badge">TZS ${job.price}</div>
                        <button onclick="startTask('${job.id}')" style="width:100%; background:var(--emr-gold); color:black; border:none; padding:15px; border-radius:12px; font-weight:900; font-size:1rem; cursor:pointer">ANZA KAZI</button>
                    </div>
                </div>`;
            });
        }

        // --- REALITY JAVA LOGIC ---

        async function likeJob(jobId, element) {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return alert("Ingia kwanza ili uweze ku-like!");

            const icon = element.querySelector('i');
            const countSpan = element.querySelector('.like-count');

            const { error } = await _supabase
                .from('job_likes')
                .insert([{ user_id: user.id, job_id: jobId }]);

            if (error) {
                await _supabase.from('job_likes').delete().match({ user_id: user.id, job_id: jobId });
                icon.style.color = 'white';
                countSpan.innerText = "Like";
            } else {
                icon.style.color = 'red';
                countSpan.innerText = "Liked";
            }
        }

        async function followMerchant(merchantId, badgeElement) {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) return alert("Ingia kwanza ili uweze ku-follow!");

            const { error } = await _supabase
                .from('followers')
                .insert([{ follower_id: user.id, merchant_id: merchantId }]);

            if (error) {
                alert("Tayari unamfuata mfanyabiashara huyu!");
            } else {
                alert("Hongera! Umeanza kumfuata.");
                badgeElement.style.display = 'none'; // Ficha (+) baada ya kufollow
            }
        }

        function shareIt() {
            if (navigator.share) navigator.share({title: 'EMR Job', url: window.location.href});
        }

        function startTask(id) {
            alert("Kazi imeanza! Piga screenshot ukimaliza.");
        }

        fetchJobs();
    </script>
</body>
</html>
