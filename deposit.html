<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit | EMR Business</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #020617; --gold: #ffc947; --card: #1e293b; --success: #22c55e; --pending: #f59e0b; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); color: white; padding: 20px; }

        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
        .section-title { font-size: 0.8rem; color: var(--gold); margin-bottom: 12px; letter-spacing: 1px; }

        /* Grid ya Icon Rasmi */
        .method-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .method-item { 
            background: var(--card); border-radius: 15px; padding: 12px; text-align: center;
            border: 2px solid transparent; cursor: pointer; transition: 0.3s;
        }
        .method-item img { width: 100%; height: 40px; object-fit: contain; margin-bottom: 5px; }
        .method-item.active { border-color: var(--gold); background: rgba(255, 201, 71, 0.05); }

        /* Maelekezo */
        .instruction-card { 
            background: rgba(255,255,255,0.03); border: 1px solid #334155; 
            border-radius: 20px; padding: 20px; margin-bottom: 20px; display: none;
        }
        .step { display: flex; gap: 12px; margin-bottom: 10px; font-size: 0.8rem; }
        .step-num { background: var(--gold); color: #000; width: 20px; height: 20px; border-radius: 50%; 
                    display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.7rem; flex-shrink: 0; }

        /* Inputs */
        .input-group { margin-bottom: 15px; }
        input { 
            width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #334155; 
            background: var(--card); color: white; outline: none; font-size: 0.9rem;
        }
        .btn-pay { 
            width: 100%; padding: 18px; background: var(--gold); border: none; 
            border-radius: 15px; font-weight: 800; color: #000; cursor: pointer; margin-bottom: 30px;
        }

        /* Historia ya Miamala */
        .history-section { margin-top: 20px; }
        .history-card { 
            background: rgba(255,255,255,0.02); padding: 15px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05);
        }
        .status-badge { font-size: 0.65rem; padding: 4px 8px; border-radius: 5px; font-weight: bold; text-transform: uppercase; }
        .pending { background: rgba(245, 158, 11, 0.2); color: var(--pending); }
        .approved { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    </style>
</head>
<body>

    <div class="header">
        <a href="merchant_dashboard.html" style="color:white"><i class="fas fa-arrow-left"></i></a>
        <h3>Weka Pesa</h3>
    </div>

    <p class="section-title">CHAGUA NJIA YA MALIPO</p>
    <div class="method-grid">
        <div class="method-item" onclick="showGuide('mpesa')">
            <img src="https://upload.wikimedia.org/wikipedia/en/d/df/M-pesa_logo.png" alt="Mpesa">
            <p style="font-size: 0.6rem;">M-Pesa</p>
        </div>
        <div class="method-item" onclick="showGuide('tigo')">
            <img src="https://logos-world.net/wp-content/uploads/2022/11/Tigo-Logo.png" alt="Tigo">
            <p style="font-size: 0.6rem;">TigoPesa</p>
        </div>
        <div class="method-item" onclick="showGuide('airtel')">
            <img src="https://upload.wikimedia.org/wikipedia/commons/3/3a/Airtel_logo.png" alt="Airtel">
            <p style="font-size: 0.6rem;">Airtel</p>
        </div>
    </div>

    <div id="guide-box" class="instruction-card">
        <h4 id="guide-title" style="margin-bottom:12px; color:var(--gold); font-size: 0.85rem;"></h4>
        <div id="steps-container"></div>
    </div>

    <div class="input-group">
        <input type="number" id="amount" placeholder="Kiasi (Kima cha chini 5,000)">
    </div>
    <div class="input-group">
        <input type="text" id="trans_id" placeholder="Transaction ID (Kumbukumbu)">
    </div>

    <button class="btn-pay" onclick="submitDeposit()">WASILISHA MALIPO</button>

    <div class="history-section">
        <p class="section-title">HISTORIA YA MIAMALA</p>
        <div id="history-list">
            <p style="font-size: 0.7rem; opacity: 0.5; text-align: center;">Inapakia historia...</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bnskxnaqjmsrtzglsdug.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_VZ5Up105f3DIr8bcrDFqmA_jwL4vA3K';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const guides = {
            mpesa: {
                title: "LIPA KWA M-PESA (LIPA NAMBA)",
                steps: ["Piga *150*00#", "Chagua 4 (Lipa kwa M-Pesa)", "Chagua 4 (Weka namba ya kampuni)", "Ingiza namba: 0740430220", "Ingiza Kiasi na Siri."]
            }
            // ...ongeza mingine kama awali
        };

        function showGuide(id) {
            document.querySelectorAll('.method-item').forEach(i => i.classList.remove('active'));
            event.currentTarget.classList.add('active');
            const g = guides[id] || {title: "MAELEKEZO", steps: ["Tuma kiasi kwenda 0740430220"]};
            document.getElementById('guide-title').innerText = g.title;
            document.getElementById('steps-container').innerHTML = g.steps.map((s, i) => `
                <div class="step"><span class="step-num">${i+1}</span><p>${s}</p></div>
            `).join('');
            document.getElementById('guide-box').style.display = 'block';
        }

        async function submitDeposit() {
            const amt = document.getElementById('amount').value;
            const tid = document.getElementById('trans_id').value;
            if(amt < 5000) return alert("Kiwango cha chini ni 5,000!");
            
            const { data: { user } } = await _supabase.auth.getUser();
            const { error } = await _supabase.from('deposits').insert([{ user_id: user.id, amount: amt, transaction_id: tid, status: 'pending' }]);
            
            if(!error) { alert("Malipo yamewasilishwa!"); fetchHistory(); }
        }

        async function fetchHistory() {
            const { data: { user } } = await _supabase.auth.getUser();
            const { data } = await _supabase.from('deposits').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
            
            document.getElementById('history-list').innerHTML = data.map(d => `
                <div class="history-card">
                    <div>
                        <p style="font-size: 0.8rem; font-weight: bold;">TZS ${d.amount.toLocaleString()}</p>
                        <p style="font-size: 0.6rem; opacity: 0.5;">${new Date(d.created_at).toLocaleString()}</p>
                    </div>
                    <span class="status-badge ${d.status}">${d.status}</span>
                </div>
            `).join('');
        }

        fetchHistory();
    </script>
</body>
</html>
