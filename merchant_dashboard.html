<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMR Merchant Dashboard | Official</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #020617; --gold: #ffc947; --card: rgba(30, 41, 59, 0.7); --wa: #25D366; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); color: white; padding-bottom: 90px; }

        /* Header - Jina Kubwa */
        .header { padding: 25px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header p { font-size: 0.8rem; opacity: 0.7; margin-bottom: 2px; }
        .header h2 { font-size: 1.4rem; color: var(--gold); font-weight: 800; }
        
        .live-chat-icon { color: var(--gold); font-size: 1.5rem; text-decoration: none; position: relative; }
        .live-chat-icon::after { content: ''; position: absolute; top: 0; right: 0; width: 8px; height: 8px; background: red; border-radius: 50%; }

        /* Balance Card */
        .balance-section { padding: 0 20px; }
        .balance-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 30px 20px; border-radius: 24px; border: 1px solid rgba(255, 201, 71, 0.2);
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }
        .balance-amount { font-size: 2.2rem; font-weight: 800; color: #fff; margin: 10px 0; letter-spacing: 1px; }
        .deposit-btn {
            display: inline-block; background: var(--gold); color: #000; padding: 12px 25px;
            border-radius: 12px; text-decoration: none; font-weight: 700; margin-top: 5px; transition: 0.3s;
        }

        /* Action Grid */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 25px 20px; }
        .card { 
            background: var(--card); padding: 25px; border-radius: 20px; text-align: center;
            border: 1px solid rgba(255,255,255,0.05); text-decoration: none; color: white; transition: 0.3s;
        }
        .card:active { transform: scale(0.95); }
        .card i { font-size: 1.8rem; color: var(--gold); margin-bottom: 12px; display: block; }
        .card span { font-size: 0.8rem; font-weight: 500; }

        /* WhatsApp Support */
        .wa-btn {
            position: fixed; bottom: 100px; right: 20px; background: var(--wa);
            width: 60px; height: 60px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(37,211,102,0.4);
            z-index: 100; text-decoration: none;
        }

        /* Admin Floating Button */
        .admin-btn {
            position: fixed; bottom: 175px; right: 20px; background: #ef4444;
            width: 60px; height: 60px; border-radius: 50%; display: none;
            align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(239,68,68,0.4);
            z-index: 101; text-decoration: none; border: 2px solid white; animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

        /* Bottom Menu */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 75px; background: #0f172a;
            display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #1e293b;
        }
        .nav-item { text-align: center; color: #64748b; text-decoration: none; font-size: 0.7rem; }
        .nav-item.active { color: var(--gold); }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <p>Karibu Boss,</p>
            <h2 id="merchant-name">Inapakia...</h2>
        </div>
        <a href="live_chat.html" class="live-chat-icon"><i class="fas fa-comment-dots"></i></a>
    </div>

    <div class="balance-section">
        <div class="balance-card">
            <p style="font-size: 0.8rem; opacity: 0.7;">Salio la Matangazo</p>
            <div class="balance-amount" id="balance-txt">TZS 0</div>
            <a href="deposit.html" class="deposit-btn">WEKA PESA</a>
        </div>
    </div>

    <div class="grid">
        <div class="card" onclick="handlePostJob()">
            <i class="fas fa-paper-plane"></i>
            <span>Anzisha Kazi</span>
        </div>
        
        <a href="merchant_order.html" class="card">
            <i class="fas fa-briefcase"></i>
            <span>kagua kazi</span>
        </a>

        <a href="merchant_jobs_list.html" class="card">
            <i class="fas fa-tasks"></i>
            <span>kazi zangu</span>
        </a>

        <a href="security.html" class="card">
            <i class="fas fa-user-shield"></i>
            <span>Usalama</span>
        </a>
    </div>

    <a href="admin_panel.html" id="admin-floating-btn" class="admin-btn">
        <i class="fas fa-user-gear" style="color:white; font-size:1.5rem;"></i>
    </a>

    <a href="https://wa.me/255740430220" class="wa-btn" target="_blank">
        <i class="fab fa-whatsapp" style="color:white; font-size:1.8rem;"></i>
    </a>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active"><i class="fas fa-home fa-lg"></i><br>Nyumbani</a>
        <a href="merchant_jobs_list.html" class="nav-item"><i class="fas fa-tasks fa-lg"></i><br>Kazi</a>
        <a href="wallet.html" class="nav-item"><i class="fas fa-wallet fa-lg"></i><br>Pesa</a>
    </nav>

    <script>
        const SUPABASE_URL = 'https://bnskxnaqjmsrtzglsdug.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_VZ5Up105f3DIr8bcrDFqmA_jwL4vA3K';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let merchantBalance = 0;

        async function loadData() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                // Tunavuta jina kutoka table ya profiles kwa uhakika
                const { data: profile } = await _supabase.from('profiles').select('full_name, balance, is_admin').eq('id', user.id).single();
                
                if (profile) {
                    // Weka jina liwe kubwa kama lilivyoandaliwa kwenye CSS
                    document.getElementById('merchant-name').innerText = profile.full_name || "Merchant";
                    
                    merchantBalance = profile.balance || 0;
                    document.getElementById('balance-txt').innerText = "TZS " + merchantBalance.toLocaleString();

                    if (profile.is_admin === 1) {
                        document.getElementById('admin-floating-btn').style.display = 'flex';
                    }
                }
            }
        }

        function handlePostJob() {
            if (merchantBalance <= 0) {
                alert("Ooh! Salio lako ni 0. Tafadhali weka pesa kwanza ili uweze kupandisha kazi.");
                window.location.href = "deposit.html";
            } else {
                window.location.href = "create_job.html";
            }
        }

        loadData();
    </script>
</body>
</html>
