<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usalama wa Pesa | EMR Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #020617; --safe: #22c55e; --gold: #ffc947; --card: #111827; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: white; padding: 20px; text-align: center; }

        .shield-box { 
            background: linear-gradient(145deg, #064e3b, #020617);
            border: 2px solid var(--safe); border-radius: 30px;
            padding: 40px 20px; margin-top: 30px; position: relative;
        }
        .lock-icon { font-size: 3rem; color: var(--safe); margin-bottom: 15px; }
        .amount-display { font-size: 2.5rem; font-weight: 900; margin: 10px 0; color: #fff; }
        
        .status-badge { background: var(--safe); color: #000; padding: 5px 15px; border-radius: 50px; font-size: 0.7rem; font-weight: 800; }

        .details-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 30px; text-align: left; }
        .detail-item { background: #1f2937; padding: 20px; border-radius: 15px; display: flex; align-items: center; gap: 15px; }
        .detail-item i { color: var(--gold); font-size: 1.2rem; }
        .detail-item h4 { font-size: 0.9rem; margin-bottom: 2px; }
        .detail-item p { font-size: 0.7rem; opacity: 0.6; }

        .btn-refresh { margin-top: 20px; background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 10px 20px; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="shield-box">
        <i class="fas fa-shield-check lock-icon"></i><br>
        <span class="status-badge">ULINZI WA ESCROW UMEWASHWA</span>
        <p style="margin-top: 20px; font-size: 0.8rem; opacity: 0.7;">Pesa ya Kazi Zilizopostiwa:</p>
        <h1 class="amount-display" id="security-balance">TZS 0</h1>
        <p style="font-size: 0.65rem; color: var(--safe);">Inalindwa na EMR Smart-Contract Logic</p>
    </div>

    <div class="details-grid">
        <div class="detail-item">
            <i class="fas fa-lock-hashtag"></i>
            <div>
                <h4>Uthibitisho wa Picha</h4>
                <p>Huwezi kulipa mpaka uhakiki ushahidi wa kazi.</p>
            </div>
        </div>
        <div class="detail-item">
            <i class="fas fa-undo"></i>
            <div>
                <h4>Refund Policy</h4>
                <p>Kazi ikighairiwa, pesa inarudi Wallet yako papo hapo.</p>
            </div>
        </div>
    </div>

    <button class="btn-refresh" onclick="calculateRealEscrow()">HAKIKI DATA SIKU HIZI</button>

    <script>
        const SUPABASE_URL = 'https://bnskxnaqjmsrtzglsdug.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_VZ5Up105f3DIr8bcrDFqmA_jwL4vA3K';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function calculateRealEscrow() {
            const { data: { user } } = await _supabase.auth.getUser();
            if(!user) return;

            // NJIA YA UHAKIKA: Tunajumlisha gharama ya kazi zote ambazo bado zina SLOTS
            const { data: jobs, error } = await _supabase
                .from('jobs')
                .select('pay_per_worker, remaining_slots')
                .eq('merchant_id', user.id);

            if (error) {
                console.error("Shida ya database:", error.message);
                return;
            }

            let totalEscrow = 0;
            if (jobs) {
                jobs.forEach(job => {
                    totalEscrow += (job.pay_per_worker * job.remaining_slots);
                });
            }

            // Onyesha data kwenye kioo
            document.getElementById('security-balance').innerText = "TZS " + totalEscrow.toLocaleString();
            
            // Pia, update hili salio kwenye table ya profiles kwa ajili ya usalama zaidi
            await _supabase.from('profiles').update({ escrow_balance: totalEscrow }).eq('id', user.id);
        }

        calculateRealEscrow();
    </script>
</body>
</html>
