<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journey | EMR MONEY</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ffffff;
            overflow: hidden;
            background: radial-gradient(circle, #2c3e50, #000000, #1a1a1a);
            background-size: 200% 200%;
            animation: moveBG 10s ease infinite;
        }

        @keyframes moveBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            width: 85%;
            max-width: 600px;
            text-align: center;
            padding: 20px;
            position: relative;
        }

        .step { 
            display: none; 
            animation: smoothFade 1.5s ease-in-out;
        }
        .step.active { display: block; }

        @keyframes smoothFade { 
            0% { opacity: 0; transform: scale(0.95); } 
            100% { opacity: 1; transform: scale(1); } 
        }

        .user-name { color: #ffc947; font-weight: 600; font-size: 1.1rem; margin-bottom: 10px; display: block; }
        .question-text { 
            font-size: 1.3rem; 
            font-weight: 300; 
            line-height: 1.8; 
            color: #f1f1f1;
            min-height: 120px;
        }

        .progress-bar {
            width: 100%;
            height: 3px;
            background: rgba(255,255,255,0.1);
            margin-top: 30px;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #ffc947;
            width: 0%;
            transition: width 0.3s linear;
        }

        .role-container { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .role-card {
            background: rgba(255,255,255,0.08);
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.15);
            transition: 0.4s;
            text-align: center;
        }
        .role-card:hover { 
            background: rgba(255, 201, 71, 0.15); 
            border-color: #ffc947; 
            transform: translateY(-5px);
        }
        .role-card h3 { margin: 0; color: #ffc947; font-size: 1.4rem; }
        .role-card p { margin: 10px 0 0; font-size: 0.9rem; color: #ddd; }

    </style>
</head>
<body>

    <div class="container">
        <div id="content-area">
            <p style="opacity: 0.5;">Inapakia safari yako...</p>
        </div>
        
        <div class="progress-bar" id="p-bar" style="display:none;">
            <div class="progress-fill" id="p-fill"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bnskxnaqjmsrtzglsdug.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_VZ5Up105f3DIr8bcrDFqmA_jwL4vA3K';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let userName = "";
        let currentIdx = 0;

        const maswali = [
            "Je, unajua kuwa ulimwengu wa kidijitali unatoa fursa sawa kwa kila mtu mwenye uthubutu kama wewe?",
            "Je, uko tayari kuona namba za wafuasi na ushawishi wako zikikua kwa kasi kubwa kuliko ulivyowahi kufikiria?",
            "Je, unaamini kuwa siri ya utajiri wa kizazi hiki imefichwa ndani ya kioo cha simu yako unayoishika sasa?",
            "Je, uko tayari kuachana na mfumo wa kizamani wa kutafuta kazi na kuanza kumiliki fursa zako mwenyewe?",
            "Je, unakubali kuwa kila sekunde unayopoteza mtandaoni bila kuzalisha thamani ni fursa iliyopotea kwako?",
            "Je, uko tayari kuingia kwenye ligi ya watu wachache wanaojua jinsi ya kugeuza 'Likes' kuwa kipato cha uhakika?",
            "Je, unaamini kuwa jina lako linaweza kuwa chapa kubwa (Brand) inayozungumzwa na maelfu ya watu hapa EMR?",
            "Je, uko tayari kuwekeza nidhamu na muda wako mfupi kwa ajili ya kupata matokeo yatakayodumu kwa muda mrefu?",
            "Je, unajua kuwa EMR MONEY imejengwa kwa ajili ya watu wenye njaa ya mafanikio makubwa kama ulivyo wewe?",
            "Swali la mwisho kabisa: Je, uko tayari kuamua hatima yako ya kibiashara sasa hivi na kuanza kazi?"
        ];

        async function init() {
            // 1. Pata user aliyelog-in
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) { window.location.href = 'login.html'; return; }
            
            // 2. Vuta jina lake kutoka kwenye table ya profiles
            const { data: profile, error: pError } = await _supabase
                .from('profiles')
                .select('full_name, status')
                .eq('id', user.id)
                .single();

            if (pError || !profile) {
                userName = "Mtumiaji"; // Fallback kama jina halipo kabisa
            } else {
                userName = profile.full_name;
            }

            // 3. Kama ana role tayari kwenye metadata, mpeleke dashboard direct
            if(user.user_metadata && user.user_metadata.role) {
                redirectUser(user.user_metadata.role);
                return;
            }

            document.getElementById('p-bar').style.display = "block";
            showQuestion();
        }

        function showQuestion() {
            if (currentIdx < maswali.length) {
                const progress = ((currentIdx + 1) / maswali.length) * 100;
                document.getElementById('p-fill').style.width = progress + "%";

                document.getElementById('content-area').innerHTML = `
                    <div class="step active">
                        <span class="user-name">${userName}</span>
                        <p class="question-text">${maswali[currentIdx]}</p>
                    </div>
                `;

                currentIdx++;
                // Nimeiweka sekunde 3.5 kama kodi yako ya awali
                setTimeout(showQuestion, 3500); 
            } else {
                showRoleSelection();
            }
        }

        function showRoleSelection() {
            document.getElementById('p-bar').style.display = "none";
            document.getElementById('content-area').innerHTML = `
                <div class="step active">
                    <span class="user-name">${userName}</span>
                    <h2 style="margin-bottom:10px;">Hatua ya Maamuzi</h2>
                    <p style="font-size:0.9rem; margin-bottom:20px; opacity:0.8;">Chagua njia moja itakayofungua milango yako ya mafanikio hapa EMR.</p>
                    <div class="role-container">
                        <div class="role-card" onclick="setRole('merchant')">
                            <h3>MFANYABIASHARA</h3>
                            <p>Nataka kukuza biashara yangu, kupata followers, likes, na wateja wengi mtandaoni.</p>
                        </div>
                        <div class="role-card" onclick="setRole('client')">
                            <h3>MFANYAKAZI (Mteja)</h3>
                            <p>Nataka kufanya kazi, kutoa huduma za kitalaamu, na kutengeneza faida kupitia EMR.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function setRole(r) {
            const statusDiv = document.getElementById('content-area');
            statusDiv.innerHTML = `<p>Tunaandaa Dashboard yako ya ${r === 'merchant' ? 'Ufanyabiashara' : 'Ufanyakazi'}...</p>`;
            
            // Tunahifadhi role kwenye metadata ili asirudi tena hapa
            const { error } = await _supabase.auth.updateUser({
                data: { role: r }
            });

            if (!error) { 
                redirectUser(r); 
            } else {
                alert("Hitilafu kuhifadhi role: " + error.message);
            }
        }

        function redirectUser(role) {
            if(role === 'merchant') window.location.href = 'merchant_dashboard.html';
            else window.location.href = 'client_dashboard.html';
        }

        init();
    </script>
</body>
</html>
